<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç©ºå£³ä¹‹å›½ï¼ˆè½»é‡äº’åŠ¨ç‰ˆï¼‰</title>
  <style>
    :root { --bg:#0b0f14; --card:#121a24; --muted:#7c8aa5; --fg:#eaf1ff; --bd:#223146; --ok:#39d98a; --warn:#ffb020; --bad:#ff5d5d; --narr:#8fb6ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", Arial; background:var(--bg); color:var(--fg); }
    header { padding:14px 16px; border-bottom:1px solid var(--bd); display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    header .title { font-weight:700; letter-spacing:.5px; }
    header .pill { padding:6px 10px; border:1px solid var(--bd); border-radius:999px; color:var(--muted); font-size:12px; }
    main { padding:14px 16px; display:grid; gap:14px; grid-template-columns: 380px 1fr; }
    @media (max-width: 980px){ main{ grid-template-columns:1fr; } }

    .panel { background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .col { display:flex; flex-direction:column; gap:8px; }
    label { font-size:12px; color:var(--muted); }
    input, select, textarea {
      background:#0d141d; border:1px solid var(--bd); color:var(--fg);
      padding:10px 10px; border-radius:10px; outline:none;
    }
    textarea { min-height:64px; resize:vertical; }
    button {
      background:#0d141d; border:1px solid var(--bd); color:var(--fg);
      padding:10px 12px; border-radius:10px; cursor:pointer;
    }
    button:hover { border-color:#38547a; }
    button.primary { background:#18263a; border-color:#365a86; }
    button.ok { border-color:rgba(57,217,138,.55); }
    button.warn { border-color:rgba(255,176,32,.55); }
    button.bad { border-color:rgba(255,93,93,.55); }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .small { font-size:12px; color:var(--muted); }
    .big { font-size:16px; font-weight:650; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .players { display:flex; flex-direction:column; gap:8px; }
    .p {
      border:1px solid var(--bd); border-radius:12px; padding:10px;
      display:flex; justify-content:space-between; gap:10px;
    }
    .p .name { font-weight:650; }
    .p .meta { font-size:12px; color:var(--muted); }
    .p.you { border-color:#4a78b5; }
    .p.turn { outline:2px solid rgba(255,176,32,.22); }
    .p .stats { display:flex; gap:8px; font-size:12px; }
    .stat { padding:4px 8px; border:1px solid var(--bd); border-radius:999px; }
    .tag { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--bd); color:var(--muted); }

    .hand { display:flex; flex-direction:column; gap:8px; }
    .card {
      border:1px solid var(--bd); border-radius:12px; padding:10px;
      display:flex; justify-content:space-between; gap:10px;
    }
    .card .left { display:flex; flex-direction:column; gap:4px; }
    .card .right { display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .card .title { font-weight:650; }
    .card .desc { font-size:12px; color:var(--muted); line-height:1.35; }
    .card .badge { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--bd); color:var(--muted); }
    .card.facedown { border-color:rgba(74,120,181,.65); }

    .log { height:540px; overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:6px; }
    .line { font-size:12px; color:#d6e3ff; opacity:.92; line-height:1.35; }
    .line.dim { color:var(--muted); }
    .line.narr { color: var(--narr); opacity: .95; border:1px dashed rgba(143,182,255,.25); background:rgba(143,182,255,.06); padding:8px 10px; border-radius:10px; }
    .sep { height:1px; background:var(--bd); margin:10px 0; }

    .timer { font-size:12px; color:var(--muted); }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; }
    .kpi .box { border:1px solid var(--bd); border-radius:12px; padding:8px 10px; }
    .kpi .box .v { font-weight:700; }

    .hintbox{
      border:1px solid rgba(255,176,32,.25);
      background:rgba(255,176,32,.05);
      border-radius:12px;
      padding:10px;
    }
    .hintbox .t{ font-weight:650; }
    .hintbox .b{ font-size:12px; color:var(--muted); line-height:1.45; margin-top:6px; }
  </style>
</head>
<body>
<header>
  <div class="title">ç©ºå£³ä¹‹å›½ï¼ˆè½»é‡äº’åŠ¨ç‰ˆï¼‰</div>
  <div class="pill" id="connPill">æœªè¿æ¥</div>
  <div class="pill">Phase: <span id="phaseText">-</span></div>
  <div class="pill">Turn: <span id="turnText">-</span></div>
  <div class="pill">æ€»ç»Ÿ: <span id="presText">-</span></div>
  <div class="pill">å½“å‰: <span id="curText">-</span></div>
  <div class="pill timer">å€’è®¡æ—¶: <span id="timerText">-</span></div>
</header>

<main>
  <!-- å·¦ä¾§ï¼šæ›´â€œå‚»ç“œåŒ–â€çš„æ“ä½œé¢æ¿ -->
  <section class="panel col">
    <div class="big">å¿«é€Ÿå¼€å§‹</div>
    <div class="grid2">
      <div class="col">
        <label>WS åœ°å€</label>
        <input id="wsUrl" value="ws://localhost:3000" />
      </div>
      <div class="col">
        <label>æˆ¿é—´å·</label>
        <input id="roomId" value="room1" />
      </div>
      <div class="col">
        <label>æ˜µç§°</label>
        <input id="name" value="ç©å®¶" />
      </div>
      <div class="col">
        <label>AI æ•°é‡ï¼ˆ0~3ï¼‰</label>
        <input id="aiCount" type="number" min="0" max="3" value="1" />
      </div>
    </div>

    <div class="row">
      <button class="primary" id="btnOneClick">ä¸€é”®å¼€å±€ï¼ˆè¿â†’è¿›â†’åŠ AIâ†’å¼€å§‹ï¼‰</button>
      <button id="btnConnect">ä»…è¿æ¥</button>
      <button id="btnDisconnect" class="bad">æ–­å¼€</button>
    </div>
    <div class="small">ä½ çš„ PlayerIdï¼š<span class="mono" id="pidText">-</span></div>

    <div class="sep"></div>

    <div class="big">å½“å‰ä½ è¯¥åšä»€ä¹ˆ</div>
    <div class="hintbox">
      <div class="t" id="nextTitle">-</div>
      <div class="b" id="nextBody">è¿æ¥åä¼šæ˜¾ç¤ºä¸‹ä¸€æ­¥æç¤ºã€‚</div>
    </div>

    <div class="sep"></div>

    <div class="big">ä½ ï¼ˆç§å¯†ï¼‰</div>
    <div class="kpi">
      <div class="box"><div class="small">è§’è‰²</div><div class="v" id="myRole">-</div></div>
      <div class="box"><div class="small">æ”¯æŒ S</div><div class="v" id="myS">-</div></div>
      <div class="box"><div class="small">ç¨³å®š T</div><div class="v" id="myT">-</div></div>
      <div class="box"><div class="small">ç­¹ç  M</div><div class="v" id="myM">-</div></div>
      <div class="box"><div class="small">ä¸å¯ä¿¡</div><div class="v" id="myU">-</div></div>
      <div class="box"><div class="small">æ”¿å˜å¨èƒ W</div><div class="v" id="myW">-</div></div>
    </div>

    <div class="sep"></div>

    <div class="big">æ“ä½œï¼ˆæŒ‰é˜¶æ®µè‡ªåŠ¨è§£é”ï¼‰</div>

    <!-- å¯†è°‹ï¼šæš—ç½®+å£°æ˜ -->
    <div class="col">
      <label>å¯†è°‹ï¼šé€‰æ‹©æš—ç½®ç‰Œ</label>
      <select id="selFacedown"></select>
      <button id="btnSetFacedown">è®¾ä¸ºæš—ç½®</button>
    </div>

    <div class="grid2">
      <div class="col">
        <label>å£°æ˜æ ‡ç­¾</label>
        <select id="selDecl">
          <option value="SUPPORT">SUPPORT æ‹‰æ”¯æŒ</option>
          <option value="ATTACK">ATTACK æå¯¹æ‰‹</option>
          <option value="MONEY">MONEY æç­¹ç </option>
          <option value="ALLY">ALLY ç»“ç›Ÿ/æ–­ç›Ÿ</option>
          <option value="COUP">COUP å‡†å¤‡/å‘åŠ¨æ”¿å˜</option>
          <option value="VOTE">VOTE å†²è®®é¢˜æŠ•ç¥¨</option>
          <option value="BLUFF">BLUFF æ‰“çƒŸé›¾å¼¹</option>
        </select>
      </div>
      <div class="col">
        <label>å£°æ˜è¡¥å……ï¼ˆ<=60å­—ï¼‰</label>
        <input id="declText" placeholder="å¯ä¸å¡«" maxlength="60" />
      </div>
    </div>
    <button id="btnSetDecl">æäº¤å£°æ˜</button>

    <div class="sep"></div>

    <!-- é€šç”¨ç›®æ ‡/é‡‘é¢ -->
    <div class="grid2">
      <div class="col">
        <label>ç›®æ ‡ç©å®¶ï¼ˆæ‰“ç‰Œ/è´¨ç–‘ï¼‰</label>
        <select id="selTarget"></select>
      </div>
      <div class="col">
        <label>é‡‘é¢ï¼ˆå±æœº/é˜»æ­¢æ”¿å˜ï¼‰</label>
        <input id="amt" type="number" min="1" max="10" value="1" />
      </div>
    </div>

    <div class="row">
      <button class="primary" id="btnPlayFacedown">è¡ŒåŠ¨ï¼šæ‰“å‡ºæš—ç½®ç‰Œ</button>
      <button class="warn" id="btnPrepCoup">è¡ŒåŠ¨ï¼šé¢„å¤‡æ”¿å˜</button>
      <button class="bad" id="btnLaunchCoup">è¡ŒåŠ¨ï¼šå‘åŠ¨æ”¿å˜</button>
      <button id="btnBreakAlliance">è¡ŒåŠ¨ï¼šæ–­ç›Ÿ</button>
    </div>

    <div class="row">
      <button id="btnChallenge">å¯†è°‹ï¼šè´¨ç–‘ç›®æ ‡</button>
      <button id="btnAcceptAlliance">ååº”ï¼šæ¥å—è”ç›Ÿ</button>
    </div>

    <div class="row">
      <button id="btnVoteYes">æŠ•ç¥¨ï¼šYES</button>
      <button id="btnVoteNo">æŠ•ç¥¨ï¼šNO</button>
      <button id="btnVoteAbstain">æŠ•ç¥¨ï¼šABSTAIN</button>
    </div>

    <div class="row">
      <button id="btnCrisisPay">å±æœºï¼šè´¡çŒ®ç­¹ç </button>
      <button id="btnCoupPay">é˜»æ­¢æ”¿å˜ï¼šè´¡çŒ®ç­¹ç </button>
    </div>

    <div class="sep"></div>

    <div class="big">èŠå¤©</div>
    <div class="row">
      <input id="chatText" placeholder="å›è½¦å‘é€" style="flex:1" />
      <button id="btnChat">å‘é€</button>
    </div>

    <div class="small">è¯´æ˜ï¼šè¿™ä¸ªå‰ç«¯ä¼šè‡ªåŠ¨æ’å…¥â€œå™äº‹æ¡£æ¡ˆâ€åˆ°æ—¥å¿—é‡Œï¼Œè®©æµç¨‹æ²¡é‚£ä¹ˆäººæœºã€‚</div>
  </section>

  <!-- å³ä¾§ï¼šå…¬å…±çŠ¶æ€ / æ‰‹ç‰Œ / æ—¥å¿— -->
  <section class="panel col">
    <div class="row" style="justify-content:space-between; align-items:flex-end;">
      <div class="col" style="gap:4px;">
        <div class="big">å…¬å…±çŠ¶æ€</div>
        <div class="small" id="agendaText">è®®é¢˜ï¼š-</div>
        <div class="small" id="coupText">æ”¿å˜ï¼š-</div>
        <div class="small" id="offerText">è”ç›Ÿææ¡ˆï¼š-</div>
      </div>
      <div class="row">
        <button id="btnPing">åˆ·æ–°</button>
        <button id="btnClearLog">æ¸…ç©ºæ—¥å¿—</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="big">ç©å®¶</div>
    <div class="players" id="players"></div>

    <div class="sep"></div>

    <div class="big">ä½ çš„æ‰‹ç‰Œï¼ˆREACTION é˜¶æ®µå¯æ‰“ååº”ç‰Œï¼‰</div>
    <div class="hand" id="hand"></div>

    <div class="sep"></div>

    <div class="big">æ—¥å¿—ï¼ˆå«å™äº‹æ¡£æ¡ˆï¼‰</div>
    <div class="log" id="log"></div>
  </section>
</main>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  let ws = null;
  let roomId = "room1";
  let playerId = null;

  let lastPublic = null;
  let lastPrivate = null;

  // -------- narrative (å†…ç½®ï¼Œæ— éœ€é¢å¤–æ–‡ä»¶) --------
  const Narrative = (function(){
    // æ¯å›åˆæœ€å¤šæ’å…¥ 1 æ¡â€œæ¡£æ¡ˆâ€
    const maxPerTurn = 1;

    const TEXT = {
      INTRO: "è¿™é‡Œä»ç„¶è¢«ç§°ä¸ºä¸€ä¸ªå›½å®¶ï¼šæœ‰å›½æ——ã€æœ‰è®®ä¼šã€æœ‰æ€»ç»Ÿã€æœ‰ä¸€å¥—è¿˜åœ¨è¿è¡Œçš„ç¨‹åºã€‚åªæ˜¯è¶Šæ¥è¶Šå°‘çš„äººå†é—®ï¼šè¿™äº›ç¨‹åºç°åœ¨è¿˜æ„å‘³ç€ä»€ä¹ˆï¼Ÿ",

      TURN_OPEN: [
        "åœ°å›¾è¿˜æŒ‚åœ¨å¢™ä¸Šï¼Œä½†è¾¹ç•Œæ¯å¤©éƒ½åœ¨å˜å¾—æ›´åƒå£å¤´çº¦å®šã€‚",
        "ç”µè§†é‡Œä»åœ¨æ’­æŠ¥â€œç»Ÿä¸€å£å¾„â€ã€‚è€Œç»Ÿä¸€ï¼Œæ­£åœ¨å¤±å»æ„ä¹‰ã€‚",
        "æ—§ç§©åºåƒä¸€æ ‹ç©ºæ¥¼ï¼šç¯è¿˜äº®ç€ï¼Œäººå·²ç»èµ°æ•£ã€‚"
      ],

      PLOTTING: [
        "å¯†è°‹å¹¶ä¸éœ€è¦ç§˜å¯†ã€‚åªéœ€è¦æ‰€æœ‰äººéƒ½å‡è£…ï¼šè‡ªå·±è¿˜ç›¸ä¿¡è§„åˆ™ã€‚",
        "å£°æ˜æ˜¯ç»™è§‚ä¼—çœ‹çš„ã€‚ç­¹ç æ˜¯ç»™ç°å®çœ‹çš„ã€‚",
        "æ¯ä¸ªäººéƒ½åœ¨è¯´â€œæˆ‘ä¼šåšä»€ä¹ˆâ€ã€‚æ²¡äººä¿è¯é‚£æ˜¯çœŸçš„ã€‚"
      ],

      CHALLENGE: "è´¨ç–‘ä¸æ˜¯ä¸ºäº†çœŸç›¸ï¼Œåªæ˜¯ä¸ºäº†æµ‹è¯•ï¼šä½ æ•¢ä¸æ•¢è¢«å½“ä¼—æ‹†ç©¿ï¼Ÿ",
      ALLIANCE_FORM: "è”ç›Ÿä¸æ˜¯æ‰¿è¯ºï¼Œåªæ˜¯æš‚æ—¶é‡åˆçš„åˆ©ç›Šã€‚è¿™ä¸ªå›½å®¶é‡Œï¼Œå…³ç³»é»˜è®¤ä¼šç ´è£‚ã€‚",
      ALLIANCE_BREAK: "åè®®è¿˜åœ¨ã€‚åªæ˜¯å·²ç»æ²¡æœ‰äººæ‰“ç®—éµå®ˆå®ƒã€‚",
      VOTE: "è®®é¢˜ä»ä¼šè¢«è®¨è®ºã€è¡¨å†³ã€è®°å½•ã€‚æ²¡äººç¡®å®šï¼šå®ƒä»¬æ˜¯å¦è¿˜ä¼šè¢«æ‰§è¡Œã€‚",
      CRISIS: "å±æœºå¹¶ä¸æ˜¯çªå‘çš„ã€‚å®ƒåªæ˜¯ç»ˆäºä¸å†è¢«æ©ç›–ã€‚",
      COUP_W: "æœ‰äººä¸å†ç­‰å¾…åˆ¶åº¦ç»™å‡ºç­”æ¡ˆã€‚ä»–ä»¬å¼€å§‹å‡†å¤‡åˆ«çš„æ–¹æ¡ˆã€‚",
      COUP_VIOLENT: "è¡—å¤´å‡ºç°ä¸æ˜çš„é›†ç»“ã€‚æ²¡æœ‰äººæ‰¿è®¤è‡ªå·±åœ¨ç»„ç»‡ï¼Œä½†æ‰€æœ‰äººéƒ½åœ¨è®¡ç®—æˆæœ¬ã€‚",
      COUP_MIL: "å†›é˜Ÿæ²¡æœ‰å®£å¸ƒç«‹åœºã€‚ä»–ä»¬åªæ˜¯åœæ­¢ç­‰å¾…å‘½ä»¤ã€‚",

      SOFT_WIN: "é€‰ä¸¾ç»“æœå·²ç»è¢«å†™åœ¨çº¸ä¸Šã€‚çœŸæ­£çš„é—®é¢˜æ˜¯ï¼šè¿™å¼ çº¸æ˜¯å¦è¿˜ç®¡ç”¨ï¼Ÿ",
      WIN_INTERRUPTED: "æƒåŠ›ä»æ¥ä¸æ˜¯è¢«æˆäºˆçš„ã€‚å®ƒåªä¼šåœ¨æ··ä¹±é‡Œè¢«å¤ºèµ°ã€‚",
      FINAL_ELECT: "å±€åŠ¿æš‚æ—¶ç¨³å®šä¸‹æ¥ã€‚æ²¡æœ‰äººå†è¯•å›¾æŒ‘æˆ˜è¿™ä¸ªç»“æœâ€”â€”è‡³å°‘ç°åœ¨æ²¡æœ‰ã€‚",
      FINAL_COUP: "ç¨‹åºä»ç„¶å­˜åœ¨ã€‚åªæ˜¯å®ƒå·²ç»ä¸å†é‡è¦ã€‚",
      FINAL_TIME: "æ··ä¹±æŒç»­å¾—å¤ªä¹…ã€‚äººä»¬å¼€å§‹é»˜è®¤ï¼šæœ€æœ‰åŠ›é‡çš„äººå°±æ˜¯èµ¢å®¶ã€‚"
    };

    let lastRoomId = null;
    let lastTurn = null;
    let lastPhase = null;
    let lastLogLen = 0;

    const seenGlobal = new Set();
    let seenThisTurn = new Set();
    let insertedThisTurn = 0;

    let sawSoftEnd = false;

    function rnd(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

    function resetRoom(roomId){
      lastRoomId = roomId;
      lastTurn = null;
      lastPhase = null;
      lastLogLen = 0;
      seenThisTurn = new Set();
      insertedThisTurn = 0;
      sawSoftEnd = false;
      // ä¸æ¸… globalï¼ˆå¯æ”¹ï¼‰
      // seenGlobal.clear();
    }

    function resetTurn(turn){
      lastTurn = turn;
      seenThisTurn = new Set();
      insertedThisTurn = 0;
      sawSoftEnd = false;
    }

    function canInsert(){
      return insertedThisTurn < maxPerTurn;
    }

    function insert(key, text){
      if(!canInsert()) return;
      // é˜²æŠ–ï¼šåŒå›åˆä¸é‡å¤
      if(seenThisTurn.has(key)) return;
      seenThisTurn.add(key);

      // æœ‰äº›åªè§¦å‘ä¸€æ¬¡ï¼ˆå…¨å±€ï¼‰
      const onceKeys = new Set(["INTRO","VOTE","CRISIS"]);
      if(onceKeys.has(key)){
        if(seenGlobal.has(key)) return;
        seenGlobal.add(key);
      }

      insertedThisTurn++;
      addNarrativeLine(text);
    }

    function addNarrativeLine(text){
      // å¾€æ—¥å¿— DOM é‡Œç›´æ¥æ’â€œæ¡£æ¡ˆâ€
      const logEl = $("log");
      const div = document.createElement("div");
      div.className = "line narr";
      div.textContent = "ã€”æ¡£æ¡ˆã€• " + text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function onState(pub){
      if(!pub) return;

      if(pub.roomId && pub.roomId !== lastRoomId){
        resetRoom(pub.roomId);
        insert("INTRO", TEXT.INTRO);
      }

      if(pub.turn != null && pub.turn !== lastTurn){
        resetTurn(pub.turn);
        insert("TURN_OPEN", rnd(TEXT.TURN_OPEN));
      }

      if(pub.phase !== lastPhase){
        const prev = lastPhase;
        lastPhase = pub.phase;

        if(pub.phase === "PLOTTING"){
          insert("PLOTTING", rnd(TEXT.PLOTTING));
        }
        if(pub.phase === "VOTE"){
          insert("VOTE", TEXT.VOTE);
        }
        if(pub.phase === "CRISIS"){
          insert("CRISIS", TEXT.CRISIS);
        }

        if(pub.phase === "END"){
          // è¯»æœ€åä¸€æ¡ log åˆ¤æ–­ç»“å±€
          const logs = pub.log || [];
          const last = logs[logs.length - 1] || "";
          if(last.includes("æ”¿å˜æˆåŠŸ") || last.includes("å†›äº‹æ¥ç®¡æˆåŠŸ") || last.includes("æš´åŠ›æ”¿å˜æˆåŠŸ")){
            insert("FINAL_COUP", TEXT.FINAL_COUP);
          } else if(last.includes("æ—¶é—´åˆ°èƒœå‡º")){
            insert("FINAL_TIME", TEXT.FINAL_TIME);
          } else {
            insert("FINAL_ELECT", TEXT.FINAL_ELECT);
          }
        }
      }

      // log å¢é‡è§¦å‘ï¼ˆæ›´æœ‰æˆï¼‰
      const logs = pub.log || [];
      const newLogs = logs.slice(lastLogLen);
      lastLogLen = logs.length;

      for(const line of newLogs){
        if(line.includes("âš–ï¸ è´¨ç–‘æˆç«‹")) insert("CHALLENGE", TEXT.CHALLENGE);
        if(line.includes("ğŸ¤ è”ç›Ÿæˆç«‹")) insert("ALLIANCE_FORM", TEXT.ALLIANCE_FORM);
        if(line.includes("æ–­ç›Ÿ") || line.includes("æ’•æ¯è”ç›Ÿ") || line.includes("æ’•æ¯åè®®")) insert("ALLIANCE_BREAK", TEXT.ALLIANCE_BREAK);
        if(line.includes("æå‡æ”¿å˜å¨èƒ")) insert("COUP_W", TEXT.COUP_W);
        if(line.includes("å‘åŠ¨ã€æš´åŠ›æ”¿å˜ã€‘")) insert("COUP_VIOLENT", TEXT.COUP_VIOLENT);
        if(line.includes("å‘åŠ¨ã€å†›äº‹æ¥ç®¡ã€‘")) insert("COUP_MIL", TEXT.COUP_MIL);

        // ä½ ä¹‹å‰è¯´çš„â€œèƒœåˆ©ä¸¤æ¬¡â€ï¼Œæˆ‘ä»¬æŠŠå®ƒåŒ…è£…æˆâ€œå®£å¸ƒèƒœåˆ©ä½†å±€åŠ¿æœªç¨³â€
        if(line.includes("ğŸ ç»ˆå±€") && line.includes("ï¼ˆé€‰ä¸¾èƒœåˆ©ï¼‰")){
          insert("SOFT_WIN", TEXT.SOFT_WIN);
          sawSoftEnd = true;
        }
        if(sawSoftEnd){
          if(line.includes("è¿›å…¥æŠ•ç¥¨é˜¶æ®µ") || line.includes("å±æœºé˜¶æ®µ") || line.includes("â–¶ï¸") || line.includes("â±ï¸ ååº”çª—å£")){
            insert("WIN_INTERRUPTED", TEXT.WIN_INTERRUPTED);
            sawSoftEnd = false;
          }
        }
      }
    }

    return { onState };
  })();

  // -------- helpers --------
  function setConn(text, ok=false){
    $("connPill").textContent = text;
    $("connPill").style.color = ok ? "var(--ok)" : "var(--muted)";
    $("connPill").style.borderColor = ok ? "rgba(57,217,138,.45)" : "var(--bd)";
  }
  function send(obj){
    if(!ws || ws.readyState !== 1) return;
    ws.send(JSON.stringify(obj));
  }
  function fmtPlayerName(pid){
    const p = lastPublic?.players?.find(x=>x.id===pid);
    return p ? `${p.name} (${p.id})` : pid;
  }
  function msLeft(endsAt){
    if(!endsAt) return null;
    return Math.max(0, endsAt - Date.now());
  }

  function phaseCanAct(){ return lastPublic?.phase === "ACTION"; }
  function phaseCanPlot(){ return lastPublic?.phase === "PLOTTING"; }
  function phaseCanVote(){ return lastPublic?.phase === "VOTE"; }
  function phaseCanCrisis(){ return lastPublic?.phase === "CRISIS"; }
  function phaseCanCoupStop(){
    const ph = lastPublic?.phase;
    return ph === "COUP_NEGOTIATION" || ph === "COUP_REACTION";
  }
  function phaseCanReact(){
    const ph = lastPublic?.phase;
    return ph === "REACTION" || ph === "COUP_NEGOTIATION" || ph === "COUP_REACTION";
  }
  function isMyTurn(){ return lastPublic && lastPublic.currentPlayerId === playerId; }

  // -------- next-step hint --------
  function setNext(title, body){
    $("nextTitle").textContent = title;
    $("nextBody").textContent = body;
  }

  function updateNextStepHint(){
    if(!ws || ws.readyState !== 1){
      return setNext("è¿˜æ²¡è¿æ¥", "ç‚¹å‡»ã€Œä¸€é”®å¼€å±€ã€æˆ–ã€Œä»…è¿æ¥ã€ã€‚");
    }
    if(!playerId){
      return setNext("è¿˜æ²¡åŠ å…¥æˆ¿é—´", "ç‚¹å‡»ã€Œä¸€é”®å¼€å±€ã€æˆ–è‡ªå·±å‘ joinï¼ˆæœ¬å‰ç«¯ä¸€é”®ä¼šè‡ªåŠ¨å®Œæˆï¼‰ã€‚");
    }
    const ph = lastPublic?.phase;
    if(!lastPublic?.started){
      return setNext("ç­‰å¾…å¼€å±€", "ç‚¹å‡»ã€Œä¸€é”®å¼€å±€ã€ä¼šè‡ªåŠ¨å¼€å§‹ï¼›æˆ–è®©ä»»æ„ç©å®¶å‘ startã€‚");
    }
    if(ph === "PLOTTING"){
      return setNext("å¯†è°‹é˜¶æ®µ", "é€‰ä¸€å¼ æš—ç½®ç‰Œ + é€‰ä¸€ä¸ªå£°æ˜æ ‡ç­¾ï¼ˆå¯é€‰å¡«è¡¥å……ï¼‰ã€‚æƒ³æäº‹å°±è´¨ç–‘åˆ«äººã€‚");
    }
    if(ph === "ACTION"){
      if(!isMyTurn()) return setNext("è¡ŒåŠ¨é˜¶æ®µ", "ç­‰è½®åˆ°ä½ ã€‚ä½ å¯ä»¥å…ˆçœ‹å±€åŠ¿ï¼šè°æ”¯æŒé«˜ã€è°ç­¹ç å¤šã€‚");
      return setNext("è½®åˆ°ä½ è¡ŒåŠ¨", "ç‚¹å‡»ã€Œæ‰“å‡ºæš—ç½®ç‰Œã€ã€‚å¼ºäººä¹Ÿå¯ä»¥ã€Œé¢„å¤‡/å‘åŠ¨æ”¿å˜ã€ã€‚");
    }
    if(ph === "REACTION"){
      return setNext("ååº”çª—å£", "ä½ å¯ä»¥åœ¨æ‰‹ç‰Œé‡Œç‚¹ã€Œæ‰“ååº”ã€ï¼›è‹¥æœ‰äººç»™ä½ æè”ç›Ÿï¼Œä¹Ÿå¯ç‚¹ã€Œæ¥å—è”ç›Ÿã€ã€‚");
    }
    if(ph === "VOTE"){
      return setNext("æŠ•ç¥¨é˜¶æ®µ", "æŠ• YES/NO/ABSTAINã€‚åˆ«å¿˜äº†ï¼šæŠ•ç¥¨ä¸æ˜¯ä¸ºäº†æ­£ä¹‰ï¼Œæ˜¯ä¸ºäº†ä¸‹æ³¨ã€‚");
    }
    if(ph === "CRISIS"){
      return setNext("å±æœºé˜¶æ®µ", "è‡ªæ„¿äº¤ç­¹ç åº”å¯¹å±æœºã€‚äº¤ä¸äº¤éƒ½è¦ä»˜ä»£ä»·ï¼šè¦ä¹ˆæŸç¨³å®šï¼Œè¦ä¹ˆæŸç­¹ç ã€‚");
    }
    if(ph === "COUP_NEGOTIATION" || ph === "COUP_REACTION"){
      return setNext("æ”¿å˜çª—å£", "ä½ å¯ä»¥å‡ºç­¹ç é˜»æ­¢ï¼Œæˆ–åœ¨æ‰‹ç‰Œé‡Œæ‰“å¯¹åº”åæ”¿å˜å¡ã€‚");
    }
    if(ph === "END"){
      return setNext("ç»ˆå±€", "è¿™ä¸€å±€ç»“æŸäº†ã€‚ä½ å¯ä»¥åˆ·æ–°é¡µé¢å¼€æ–°æˆ¿é—´ï¼Œæˆ–æ¢ roomId å†æ¥ä¸€å±€ã€‚");
    }
    setNext("è¿›è¡Œä¸­", "æ ¹æ®å³ä¾§æ—¥å¿—è¡ŒåŠ¨ã€‚");
  }

  // -------- log helpers --------
  function addHintLine(msg){
    const logEl = $("log");
    const div = document.createElement("div");
    div.className = "line dim";
    div.textContent = `ï¼ˆæç¤ºï¼‰${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }
  function addErrorLine(msg){
    const logEl = $("log");
    const div = document.createElement("div");
    div.className = "line dim";
    div.textContent = `ï¼ˆé”™è¯¯ï¼‰${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // -------- render --------
  function render(){
    const pub = lastPublic;
    const priv = lastPrivate;

    $("phaseText").textContent = pub?.phase ?? "-";
    $("turnText").textContent = pub?.turn ?? "-";
    $("presText").textContent = pub?.presidentId ? fmtPlayerName(pub.presidentId) : "-";
    $("curText").textContent = pub?.currentPlayerId ? fmtPlayerName(pub.currentPlayerId) : "-";
    $("pidText").textContent = playerId ?? "-";

    // agenda / offer / coup
    if(pub?.agenda){
      $("agendaText").textContent = `è®®é¢˜ï¼š${pub.agenda.name}ï½œ${pub.agenda.text}ï½œå±æœºé˜ˆå€¼=${pub.agenda.crisisNeed}ï¼ˆ${pub.agenda.crisisText}ï¼‰`;
    } else $("agendaText").textContent = "è®®é¢˜ï¼š-";

    if(pub?.allianceOffer){
      $("offerText").textContent = `è”ç›Ÿææ¡ˆï¼š${fmtPlayerName(pub.allianceOffer.fromId)} â†’ ${fmtPlayerName(pub.allianceOffer.toId)}`;
    } else $("offerText").textContent = "è”ç›Ÿææ¡ˆï¼š-";

    if(pub?.coup){
      const t = pub.coup.type === "VIOLENT" ? "æš´åŠ›æ”¿å˜" : "å†›äº‹æ¥ç®¡";
      $("coupText").textContent = `æ”¿å˜ï¼š${t}ï½œå‘åŠ¨è€…=${fmtPlayerName(pub.coup.leaderId)}ï½œé˜»æ­¢æ€»ç­¹ç =${pub.coup.totalContrib}ï½œblockedByCard=${pub.coup.blockedByCard}ï½œæˆªæ­¢=${new Date(pub.coup.endsAt).toLocaleTimeString()}`;
    } else $("coupText").textContent = "æ”¿å˜ï¼š-";

    // players list
    const playersEl = $("players");
    playersEl.innerHTML = "";
    (pub?.players || []).forEach(p=>{
      const el = document.createElement("div");
      el.className = "p" + (p.id === playerId ? " you":"") + (p.id === pub?.currentPlayerId ? " turn":"");
      const left = document.createElement("div");
      left.innerHTML = `
        <div class="name">${p.name} <span class="tag">${p.kind}${p.exposed ? "ï½œæš´éœ²" : ""}</span></div>
        <div class="meta mono">${p.id}${p.allianceWith ? ` ï½œç›Ÿå‹:${fmtPlayerName(p.allianceWith)}` : ""}${p.untrusted ? ` ï½œä¸å¯ä¿¡:${p.untrusted}` : ""}</div>
      `;
      const right = document.createElement("div");
      right.className = "stats";
      right.innerHTML = `
        <div class="stat">S ${p.S}</div>
        <div class="stat">T ${p.T}</div>
        <div class="stat">M ${p.M}</div>
        <div class="stat">W ${p.coupW || 0}</div>
      `;
      el.appendChild(left);
      el.appendChild(right);
      playersEl.appendChild(el);
    });

    // private KPIs
    if(priv?.me){
      $("myRole").textContent = priv.me.role ?? "-";
      $("myS").textContent = priv.me.S ?? "-";
      $("myT").textContent = priv.me.T ?? "-";
      $("myM").textContent = priv.me.M ?? "-";
      $("myU").textContent = priv.me.untrusted ?? 0;
      $("myW").textContent = priv.me.coupW ?? 0;
    } else {
      $("myRole").textContent = "-";
      $("myS").textContent = "-";
      $("myT").textContent = "-";
      $("myM").textContent = "-";
      $("myU").textContent = "-";
      $("myW").textContent = "-";
    }

    // targets select
    const selT = $("selTarget");
    const prev = selT.value;
    selT.innerHTML = `<option value="">ï¼ˆè‡ªåŠ¨/é»˜è®¤ç›®æ ‡ï¼‰</option>`;
    (pub?.players || []).forEach(p=>{
      if(p.id === playerId) return;
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.name} (${p.id})`;
      selT.appendChild(opt);
    });
    if([...selT.options].some(o=>o.value===prev)) selT.value = prev;

    // facedown select from private hand
    const selF = $("selFacedown");
    const prevF = selF.value;
    selF.innerHTML = "";
    (priv?.me?.hand || []).forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = `${c.name} [${c.type}/${c.tag}]`;
      selF.appendChild(opt);
    });
    if([...selF.options].some(o=>o.value===prevF)) selF.value = prevF;

    // hand render
    const handEl = $("hand");
    handEl.innerHTML = "";
    (priv?.me?.hand || []).forEach(c=>{
      const card = document.createElement("div");
      const isFD = priv?.me?.facedownId && priv.me.facedownId === c.id;
      card.className = "card" + (isFD ? " facedown":"");
      card.innerHTML = `
        <div class="left">
          <div class="title">${c.name}
            <span class="badge">${c.type}</span>
            <span class="badge">${c.tag}</span>
            ${isFD ? `<span class="badge">æš—ç½®</span>`:""}
          </div>
          <div class="desc">${c.text || ""}</div>
        </div>
        <div class="right">
          <button data-reaction="${c.id}" ${c.type!=="REACTION" ? "disabled":""}>æ‰“ååº”</button>
        </div>
      `;
      card.querySelector("button").addEventListener("click", ()=>{
        if(!phaseCanReact()) return addHintLine("å½“å‰ä¸æ˜¯ååº”çª—å£/æ”¿å˜çª—å£");
        send({ type:"reaction", roomId, cardId: c.id });
      });
      handEl.appendChild(card);
    });

    // enable/disable buttonsï¼ˆè‡ªåŠ¨åŒ–åï¼ŒæŒ‰é’®åªæ˜¯â€œä¿é™©â€ï¼‰
    $("btnSetFacedown").disabled = !(phaseCanPlot() && priv?.me?.hand?.length);
    $("btnSetDecl").disabled = !phaseCanPlot();
    $("btnPlayFacedown").disabled = !(phaseCanAct() && isMyTurn());
    $("btnPrepCoup").disabled = !(phaseCanAct() && isMyTurn());
    $("btnLaunchCoup").disabled = !(phaseCanAct() && isMyTurn());
    $("btnBreakAlliance").disabled = !(phaseCanAct() && isMyTurn());

    $("btnChallenge").disabled = !phaseCanPlot();
    $("btnAcceptAlliance").disabled = !(lastPublic?.allianceOffer && phaseCanReact());

    $("btnVoteYes").disabled = !phaseCanVote();
    $("btnVoteNo").disabled = !phaseCanVote();
    $("btnVoteAbstain").disabled = !phaseCanVote();

    $("btnCrisisPay").disabled = !phaseCanCrisis();
    $("btnCoupPay").disabled = !phaseCanCoupStop();

    updateNextStepHint();
  }

  function renderLog(){
    const pub = lastPublic;
    const logEl = $("log");
    logEl.innerHTML = "";
    (pub?.log || []).forEach((line)=>{
      const div = document.createElement("div");
      div.className = "line";
      div.textContent = line;
      logEl.appendChild(div);
    });
    logEl.scrollTop = logEl.scrollHeight;
  }

  // -------- timer UI --------
  setInterval(()=>{
    const endsAt = lastPublic?.phaseEndsAt;
    if(!endsAt) { $("timerText").textContent = "-"; return; }
    const left = msLeft(endsAt);
    $("timerText").textContent = `${Math.ceil(left/1000)}s`;
  }, 250);

  // -------- ws events --------
  function connect(){
    if(ws && ws.readyState === 1) return;
    const url = $("wsUrl").value.trim();
    ws = new WebSocket(url);
    setConn("è¿æ¥ä¸­â€¦", false);

    ws.onopen = ()=>{
      setConn("å·²è¿æ¥", true);
      addHintLine("WS è¿æ¥æˆåŠŸ");
      updateNextStepHint();
    };

    ws.onclose = ()=>{
      setConn("å·²æ–­å¼€", false);
      addHintLine("WS è¿æ¥å…³é—­");
      ws = null;
      playerId = null;
      lastPublic = null;
      lastPrivate = null;
      $("pidText").textContent = "-";
      render();
      renderLog();
      updateNextStepHint();
    };

    ws.onerror = ()=>{
      addErrorLine("WS é”™è¯¯ï¼ˆè¯·æ£€æŸ¥ç«¯å£/åœ°å€ï¼‰");
    };

    ws.onmessage = (ev)=>{
      let msg = null;
      try { msg = JSON.parse(ev.data); } catch { return; }

      if(msg.type === "error"){
        addErrorLine(msg.message);
        return;
      }

      if(msg.type === "joined"){
        playerId = msg.playerId;
        lastPublic = msg.state || lastPublic;
        addHintLine(`åŠ å…¥æˆåŠŸï¼š${playerId}`);
        render();
        renderLog();
        // å™äº‹ï¼ˆå¯èƒ½è§¦å‘ INTRO/å›åˆå¼€åœºï¼‰
        Narrative.onState(lastPublic);
        updateNextStepHint();
        return;
      }

      if(msg.type === "state"){
        lastPublic = msg.state;

        // å…ˆæ¸²æŸ“çœŸå®æ—¥å¿—
        render();
        renderLog();

        // å†è®©å™äº‹æ’å…¥â€œæ¡£æ¡ˆâ€ï¼ˆæ’åœ¨æ—¥å¿—åº•éƒ¨ï¼‰
        Narrative.onState(lastPublic);

        updateNextStepHint();
        return;
      }

      if(msg.type === "private"){
        lastPrivate = msg.state;
        render();
        return;
      }
    };
  }

  async function oneClickStart(){
    // ä¸€é”®ï¼šconnect -> join -> add_ai -> start
    const url = $("wsUrl").value.trim();
    roomId = $("roomId").value.trim() || "room1";
    const name = $("name").value.trim() || "ç©å®¶";
    const aiCount = Math.max(0, Math.min(3, Number($("aiCount").value || 0)));

    if(!ws || ws.readyState !== 1){
      connect();
      // ç­‰è¿æ¥
      await waitFor(()=>ws && ws.readyState === 1, 3000);
    }

    send({ type:"join", roomId, name });
    // ç­‰ playerId
    await waitFor(()=>!!playerId, 3000);

    if(aiCount > 0){
      send({ type:"add_ai", roomId, count: aiCount });
      await sleep(150);
    }

    send({ type:"start", roomId });
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
  async function waitFor(fn, timeoutMs){
    const start = Date.now();
    while(Date.now() - start < timeoutMs){
      if(fn()) return true;
      await sleep(50);
    }
    return false;
  }

  // -------- actions --------
  $("btnOneClick").addEventListener("click", ()=> oneClickStart().catch(()=>addErrorLine("ä¸€é”®å¼€å±€å¤±è´¥ï¼ˆæ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨ï¼‰")));
  $("btnConnect").addEventListener("click", connect);
  $("btnDisconnect").addEventListener("click", ()=>{ if(ws) ws.close(); });

  $("btnPing").addEventListener("click", ()=>{
    if(!ws || ws.readyState !== 1) return addHintLine("è¯·å…ˆè¿æ¥ WS");
    roomId = $("roomId").value.trim() || "room1";
    send({ type:"ping_state", roomId });
  });

  $("btnClearLog").addEventListener("click", ()=>{ $("log").innerHTML = ""; });

  $("btnSetFacedown").addEventListener("click", ()=>{
    if(!phaseCanPlot()) return addHintLine("å½“å‰ä¸æ˜¯å¯†è°‹é˜¶æ®µ");
    const cardId = $("selFacedown").value;
    if(!cardId) return addHintLine("è¯·å…ˆé€‰ä¸€å¼ ç‰Œ");
    send({ type:"plot_set_facedown", roomId, cardId });
  });

  $("btnSetDecl").addEventListener("click", ()=>{
    if(!phaseCanPlot()) return addHintLine("å½“å‰ä¸æ˜¯å¯†è°‹é˜¶æ®µ");
    const tag = $("selDecl").value;
    const text = $("declText").value || "";
    send({ type:"plot_set_declaration", roomId, tag, text });
  });

  $("btnChallenge").addEventListener("click", ()=>{
    if(!phaseCanPlot()) return addHintLine("è´¨ç–‘åªèƒ½åœ¨å¯†è°‹é˜¶æ®µ");
    const targetId = $("selTarget").value;
    if(!targetId) return addHintLine("è¯·é€‰æ‹©è´¨ç–‘ç›®æ ‡");
    send({ type:"challenge", roomId, targetId });
  });

  $("btnPlayFacedown").addEventListener("click", ()=>{
    if(!phaseCanAct()) return addHintLine("å½“å‰ä¸æ˜¯è¡ŒåŠ¨é˜¶æ®µ");
    if(!isMyTurn()) return addHintLine("è¿˜æ²¡è½®åˆ°ä½ ");
    const targetId = $("selTarget").value || null;
    send({ type:"action", roomId, actionKey:"PLAY_FACEDOWN", payload:{ targetId } });
  });

  $("btnPrepCoup").addEventListener("click", ()=>{
    if(!phaseCanAct()) return addHintLine("å½“å‰ä¸æ˜¯è¡ŒåŠ¨é˜¶æ®µ");
    if(!isMyTurn()) return addHintLine("è¿˜æ²¡è½®åˆ°ä½ ");
    send({ type:"action", roomId, actionKey:"PREP_COUP", payload:{} });
  });

  $("btnLaunchCoup").addEventListener("click", ()=>{
    if(!phaseCanAct()) return addHintLine("å½“å‰ä¸æ˜¯è¡ŒåŠ¨é˜¶æ®µ");
    if(!isMyTurn()) return addHintLine("è¿˜æ²¡è½®åˆ°ä½ ");
    send({ type:"action", roomId, actionKey:"LAUNCH_COUP", payload:{} });
  });

  $("btnBreakAlliance").addEventListener("click", ()=>{
    if(!phaseCanAct()) return addHintLine("å½“å‰ä¸æ˜¯è¡ŒåŠ¨é˜¶æ®µ");
    if(!isMyTurn()) return addHintLine("è¿˜æ²¡è½®åˆ°ä½ ");
    send({ type:"action", roomId, actionKey:"BREAK_ALLIANCE", payload:{} });
  });

  $("btnAcceptAlliance").addEventListener("click", ()=>{
    if(!phaseCanReact()) return addHintLine("å½“å‰ä¸æ˜¯ååº”çª—å£");
    send({ type:"accept_alliance", roomId });
  });

  $("btnVoteYes").addEventListener("click", ()=> send({ type:"vote", roomId, choice:"YES" }));$("btnVoteYes").addEventListener("click"â€œç‚¹å‡»â€, () => send({ typeç±»å‹: "vote"â€œæŠ•ç¥¨â€, roomIdæˆ¿é—´ID, choiceé€‰æ‹©: "YES" }));
  $("btnVoteNo").addEventListener("click", ()=> sendå‘é€å‘é€({ type:"vote", roomId, choiceé€‰æ‹©:"NO"â€œä¸â€ }));$("btnVoteNo").addEventListener("click", () => sendå‘é€å‘é€({ type: "vote", roomId, choiceé€‰æ‹©: "NO"â€œä¸â€ }));$("btnVoteNo").addEventListener("click", () => send({ type: "vote", roomId, choice: "NO", "ä¸" }));
  $("btnVoteAbstain").addEventListener("click", ()=> send({ type:"vote", roomId, choice:"ABSTAIN" }));$("btnVoteAbstain").addEventListener("click", () => send({ type: "vote", roomId, choice: "ABSTAIN" }));$("btnVoteAbstain").addEventListener("click", () => send({ type: "vote", roomId, choiceé€‰æ‹©: "ABSTAIN" }));$("btnVoteAbstain").addEventListener("click", ()=> send({ type:"vote", roomId, choice:"ABSTAIN" }));$("btnVoteAbstain").addEventListener("click", () => send({ type: "vote", roomId, choice: "ABSTAIN" }));$("btnVoteAbstain").addEventListener("click", () => send({ type: "vote", roomId, é€‰æ‹©: "ABSTAIN" }));

  $("btnCrisisPay").addEventListener("click", ()=>{
    if(!phaseCanCrisis()) return addHintLine("å½“å‰ä¸æ˜¯å±æœºé˜¶æ®µ");å¦‚æœ(!phaseCanCrisis()) è¿”å› addHintLine(â€œå½“å‰ä¸æ˜¯å±æœºé˜¶æ®µâ€);
    constå¸¸é‡ å¸¸é‡amount = Mathæ•°å­¦.maxæœ€å¤§(1, Mathæ•°å­¦.min(10, Number($("amt").valueå€¼ || 1)));æ•°å­¦.æœ€å¤§(1, æ•°å­¦.æœ€å°(10, æ•°å­—($("é‡‘é¢").å€¼ || 1)));
    send({ type:"crisis_contribute", roomId, amount });å‘é€({ type:"crisis_contribute", roomId, amount });
  });

  $("btnCoupPay").addEventListener("click", ()=>{
    if(!phaseCanCoupStop()) return addHintLine("å½“å‰ä¸æ˜¯æ”¿å˜é˜»æ­¢é˜¶æ®µ");å¦‚æœ(!phaseCanCoupStop()) è¿”å› addHintLine(â€œå½“å‰ä¸æ˜¯æ”¿å˜é˜»æ­¢é˜¶æ®µâ€);
    const amount = Math.max(1, Math.min(10, Number($("amt").value || 1)));
    send({ type:"coup_contribute", roomId, amount });å‘é€({ type:"coup_contribute", roomId, amount });å‘é€({ ç±»å‹:"coup_contribute", æˆ¿é—´ID, é‡‘é¢ });å‘é€({ ç±»å‹:"coup_contribute", æˆ¿é—´ID, é‡‘é¢ });
  });

  function sendChat(){
    const text = $("chatText").value.trim();
    if(!text) return;
    send({ type:"chat", roomId, text });å‘é€({ ç±»å‹:"èŠå¤©", roomId, æ–‡æœ¬ });å‘é€({ ç±»å‹:"èŠå¤©", roomId, æ–‡æœ¬ });å‘é€({ ç±»å‹:"èŠå¤©", roomId, æ–‡æœ¬ });
    $("chatText").value = "";$(â€œèŠå¤©æ–‡æœ¬â€).å€¼ = "";$("chatText"â€œèŠå¤©æ–‡æœ¬â€).valueå€¼å€¼å€¼å€¼å€¼å€¼å€¼å€¼å€¼å€¼å€¼å€¼å€¼å€¼å€¼å€¼="";â€œèŠå¤©æ–‡æœ¬â€å€¼
  }
  $("btnChat").addEventListener("click", sendChat);$("btnChat").addEventListener("click", sendChat);$("btnChat").addEventListener("click", sendChat);$("btnChat").addEventListener("click", sendChat);$("btnChat").addEventListener("click", sendChat);
  $("chatText"â€œèŠå¤©æ–‡æœ¬â€).addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendChat(); });$("chatText"â€œèŠå¤©æ–‡æœ¬â€â€œèŠå¤©æ–‡æœ¬â€).addEventListener"keydown",e=>{ifkey==="Enter"sendChat;}$("chatText"â€œèŠå¤©æ–‡æœ¬â€).addEventListener("keydown", e => {if(key === "Enter") sendChat;});ifkey$("chatText").addEventListener("keydown", e => {if(key === "Enter") sendChat;});ifkey

  // initial UI// åˆå§‹UI
  setConn("æœªè¿æ¥", false);
  updateNextStepHint();
  render();æ¸²æŸ“();
  renderLog();æ¸²æŸ“æ—¥å¿—();
})();
</script>
</body>
</html>
