<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç©ºå£³ä¹‹å›½ Â· åœ¨çº¿åŸå‹</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; max-width: 560px; }
    button { padding: 8px 10px; border-radius: 10px; border: 1px solid #ccc; background: #fafafa; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    input { padding: 8px; border-radius: 10px; border: 1px solid #ccc; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .small { font-size: 12px; color: #666; }
    .log { height: 280px; overflow: auto; background: #fcfcfc; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #ddd; margin-right: 6px;}
    .warn { color: #b00; }
  </style>
</head>
<body>
  <h2>ã€Šç©ºå£³ä¹‹å›½ã€‹åœ¨çº¿åŸå‹</h2>
  <div class="card">
    <div class="row">
      <input id="wsUrl" style="min-width:260px" value="ws://localhost:3000" />
      <input id="roomId" placeholder="æˆ¿é—´å·ï¼ˆéšä¾¿å¡«ï¼‰" />
      <input id="name" placeholder="ä½ çš„åå­—" />
      <button id="btnJoin">åŠ å…¥</button>
    </div>
    <div class="small">è¦å‘ç¾¤é‡Œçº¿ä¸Šç©ï¼šæŠŠ ws åœ°å€æ”¹æˆä½ éƒ¨ç½²åçš„åœ°å€ï¼ˆä¾‹å¦‚ wss://xxx.onrender.comï¼‰ã€‚</div>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="card" style="flex:1; min-width: 360px;">
      <h3>å…¬å…±å±€åŠ¿</h3>
      <div id="publicState" class="mono"></div>
      <div id="eventBox" class="small"></div>
      <div style="margin-top:10px" class="row">
        <button id="btnAddAI1">+AI x1</button>
        <button id="btnAddAI2">+AI x2</button>
        <button id="btnStart">å¼€å§‹æ¸¸æˆ</button>
        <span id="err" class="warn"></span>
      </div>

      <h3 style="margin-top:14px">è¡ŒåŠ¨ï¼ˆè½®åˆ°ä½ æ‰èƒ½ç‚¹ï¼‰</h3>
      <div id="actions" class="row"></div>

      <h3 style="margin-top:14px">æš—çº¿ï¼ˆshadow é˜¶æ®µï¼‰</h3>
      <div class="row">
        <button id="btnShadowSkip">ä¸å‘åŠ¨</button>
        <button id="btnShadowPop">æ°‘ç²¹å¼ºäººï¼šå¤ºå–è®®ç¨‹</button>
        <button id="btnShadowAut">ç‹¬è£å¼ºäººï¼šå†»ç»“æœºæ„</button>
      </div>
      <div class="small">æç¤ºï¼šæš—çº¿æŠ€èƒ½æ¯å±€ä¸€æ¬¡ï¼›ä¼šå¢åŠ æš´éœ²åº¦ã€‚</div>
    </div>

    <div class="card" style="flex:1; min-width: 360px;">
      <h3>ä½ çš„ç§å¯†ä¿¡æ¯</h3>
      <div id="privateState" class="mono"></div>
      <div class="small">é˜µè¥æ˜¯æ˜ç‰Œï¼›èº«ä»½ï¼ˆå¼ºäºº/æ™®é€šï¼‰åªæœ‰ä½ è‡ªå·±èƒ½çœ‹åˆ°ã€‚</div>

      <h3 style="margin-top:14px">èŠå¤© / ç¾¤èŠå‘³é“</h3>
      <div class="row">
        <input id="chatText" style="flex:1; min-width:220px" placeholder="å‘ç‚¹åæ§½/ç«™é˜Ÿ/é˜´é˜³æ€ªæ°”éƒ½è¡Œ" />
        <button id="btnChat">å‘é€</button>
      </div>
      <div id="log" class="card log mono" style="margin-top:10px"></div>
    </div>
  </div>

<script>
let ws, myPlayerId = null, currentRoom = null;
let lastPublic = null, lastPrivate = null;

const ACTIONS = [
  { key: "mobilize_unify", label: "åŠ¨å‘˜Â·å›¢ç»“", tip: "+Lï¼ŒèŠ±R1" },
  { key: "mobilize_divide", label: "åŠ¨å‘˜Â·ç…½åŠ¨", tip: "+C -Lï¼ŒèŠ±R1ï¼ˆæ›´åƒæ°‘ç²¹ï¼‰" },
  { key: "infiltrate", label: "æ¸—é€æœºæ„", tip: "+C++ -Lï¼ŒèŠ±R2ï¼ˆå‰æ”¿å…šæ›´ä¾¿å®œï¼‰" },
  { key: "agenda", label: "æ¨åŠ¨è®®ç¨‹", tip: "æ¨è¿›èƒœåˆ©è¿›åº¦ï¼ŒèŠ±R2" },
  { key: "investigate", label: "è°ƒæŸ¥/çˆ†æ–™", tip: "æŠ¬å¯¹æ‰‹æš´éœ²/å‰Šèµ„æºï¼ŒèŠ±R1" },
  { key: "foreign_ops", label: "å¯¹å¤–æ“ä½œ", tip: "+E++ -L -Pï¼ŒèŠ±R1ï¼ˆå¢ƒå¤–æ›´å¼ºï¼‰" },
  { key: "trade", label: "æ”¿ç­–äº¤æ˜“", tip: "+R1 -L1ï¼ˆæš—ç®±æ“ä½œï¼‰" },
];

function el(id){ return document.getElementById(id); }
function setErr(t){ el("err").innerText = t || ""; }

function connectAndJoin() {
  setErr("");
  const url = el("wsUrl").value.trim();
  const roomId = el("roomId").value.trim() || "room";
  const name = el("name").value.trim() || "ç©å®¶";
  currentRoom = roomId;

  ws = new WebSocket(url);
  ws.onopen = () => {
    ws.send(JSON.stringify({ type:"join", roomId, name }));
  };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === "joined") {
      myPlayerId = msg.playerId;
      renderPublic(msg.state);
      buildActions();
      pingPrivate();
    }
    if (msg.type === "state") renderPublic(msg.state);
    if (msg.type === "private") renderPrivate(msg.state);
    if (msg.type === "error") setErr(msg.message);
  };
  ws.onclose = () => setErr("è¿æ¥æ–­å¼€ï¼ˆåˆ·æ–°é‡è¿ï¼‰");
}

function pingPrivate(){
  if (!ws || ws.readyState !== 1) return;
  ws.send(JSON.stringify({ type:"ping_state", roomId: currentRoom }));
}

function send(type, payload){
  if (!ws || ws.readyState !== 1) return setErr("æœªè¿æ¥");
  ws.send(JSON.stringify({ type, roomId: currentRoom, ...payload }));
}

function renderPublic(state){
  lastPublic = state;
  const s = state;
  const meTurn = s.players[s.currentPlayerIdx]?.id === myPlayerId;
  const lines = [];
  lines.push(`å›åˆ: ${s.turn}/${8}  é˜¶æ®µ: ${s.phase}  å½“å‰è¡ŒåŠ¨è€…: ${s.players[s.currentPlayerIdx]?.name || "-"}`);
  lines.push(`L(åˆæ³•æ€§): ${s.L}   C(æ§åˆ¶åŠ›): ${s.C}   P(ç¹è£): ${s.P}   E(å¤–éƒ¨å½±å“): ${s.E}   å±æœºå±‚æ•°: ${s.crisis}`);
  if (s.winner) lines.push(`ğŸ èƒœåˆ©æ–¹: ${s.winner}  |  ç»“å±€: ${s.ending}`);
  el("publicState").innerText = lines.join("\n");

  // äº‹ä»¶
  if (s.eventTop) {
    el("eventBox").innerText = `ğŸ“° äº‹ä»¶ï¼š${s.eventTop.name} â€”â€” ${s.eventTop.text}ï¼ˆå½±å“ï¼š${JSON.stringify(s.eventTop.effects)}ï¼‰`;
  } else {
    el("eventBox").innerText = "";
  }

  // ç©å®¶åˆ—è¡¨
  const plist = s.players.map((p, idx) => {
    const tag = idx === s.currentPlayerIdx ? "â–¶" : " ";
    return `${tag} ${p.name} [${p.kind}] é˜µè¥:${p.faction} R:${p.R} è®®ç¨‹:${p.agenda} æš´éœ²:${p.exposure}${p.usedSecret ? "ï¼ˆå·²ç”¨æš—çº¿ï¼‰" : ""}`;
  }).join("\n");
  el("publicState").innerText += "\n\n" + plist;

  // æ—¥å¿—
  el("log").innerText = s.log.join("\n");
  el("log").scrollTop = el("log").scrollHeight;

  // æŒ‰é’®å¯ç”¨æ€§
  for (const btn of document.querySelectorAll("[data-action]")) {
    btn.disabled = !(s.started && s.phase === "action" && meTurn && !s.winner);
  }
  el("btnStart").disabled = s.started || s.players.length < 2;
  el("btnAddAI1").disabled = s.started;
  el("btnAddAI2").disabled = s.started;

  // æš—çº¿æŒ‰é’®
  const myShadowTurn = (s.phase === "shadow" && !s.winner && shadowWhoseTurnIsMine());
  el("btnShadowSkip").disabled = !myShadowTurn;
  el("btnShadowPop").disabled = !myShadowTurn;
  el("btnShadowAut").disabled = !myShadowTurn;
}

function shadowWhoseTurnIsMine(){
  // å‰ç«¯ä¸çŸ¥é“ shadowQueueï¼Œåªèƒ½ç”¨ç§å¯†ä¿¡æ¯æç¤º+è½®è½¬ä½“éªŒ
  // è¿™é‡Œç”¨â€œå½“å‰è¡ŒåŠ¨è€…â€ä¸å‡†ç¡®ï¼Œæ‰€ä»¥ç®€åŒ–ï¼šå…è®¸ä½ ç‚¹ï¼Œåç«¯ä¼šåˆ¤æ–­å¹¶æŠ¥é”™
  return true;
}

function renderPrivate(pstate){
  lastPrivate = pstate;
  if (!pstate || !pstate.me) return;
  const me = pstate.me;
  el("privateState").innerText =
`ä½ æ˜¯ï¼š${me.name}
é˜µè¥ï¼ˆæ˜ç‰Œï¼‰ï¼š${me.faction}
èº«ä»½ï¼ˆæš—ç‰Œï¼‰ï¼š${me.role}
æš—çº¿æŠ€èƒ½ï¼š${me.secretSkill?.name || "æ— "} - ${me.secretSkill?.desc || ""}
èµ„æºRï¼š${me.R}   è®®ç¨‹ï¼š${me.agenda}   æš´éœ²åº¦ï¼š${me.exposure}
æš—çº¿ä½¿ç”¨ï¼š${me.usedSecret ? "å·²ç”¨" : "æœªç”¨"}`
}

function buildActions(){
  const box = el("actions");
  box.innerHTML = "";
  for (const a of ACTIONS){
    const b = document.createElement("button");
    b.innerHTML = `<div>${a.label}</div><div class="small">${a.tip}</div>`;
    b.dataset.action = a.key;
    b.onclick = () => send("action", { actionKey: a.key });
    box.appendChild(b);
  }
}

el("btnJoin").onclick = connectAndJoin;
el("btnAddAI1").onclick = () => send("add_ai", { count: 1 });
el("btnAddAI2").onclick = () => send("add_ai", { count: 2 });
el("btnStart").onclick = () => send("start", {});
el("btnChat").onclick = () => {
  const t = el("chatText").value.trim();
  if (!t) return;
  send("chat", { text: t });
  el("chatText").value = "";
};

// æš—çº¿
el("btnShadowSkip").onclick = () => send("shadow", { skillKey: "skip" });
el("btnShadowPop").onclick = () => send("shadow", { skillKey: "populist_overdrive" });
el("btnShadowAut").onclick = () => send("shadow", { skillKey: "autocrat_freeze" });

</script>
</body>
</html>
